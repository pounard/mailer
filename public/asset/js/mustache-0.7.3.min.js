(function(a,b){if(typeof exports==="object"&&exports){b(exports)}else{var c={};b(c);if(typeof define==="function"&&define.amd){define(c)}else{a.Mustache=c}}}(this,function(l){var m=/\s*/;var n=/\s+/;var o=/\S/;var p=/\s*=/;var q=/\s*\}/;var r=/#|\^|\/|>|\{|&|=|!/;var t=RegExp.prototype.test;function testRegExp(a,b){return t.call(a,b)}function isWhitespace(a){return!testRegExp(o,a)}var u=Object.prototype.toString;var v=Array.isArray||function(a){return u.call(a)==='[object Array]'};function isFunction(a){return typeof a==='function'}function escapeRegExp(a){return a.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}var w={"&":"&amp;","<":"&lt;",">":"&gt;",'"':'&quot;',"'":'&#39;',"/":'&#x2F;'};function escapeHtml(a){return String(a).replace(/[&<>"'\/]/g,function(s){return w[s]})}function Scanner(a){this.string=a;this.tail=a;this.pos=0}Scanner.prototype.eos=function(){return this.tail===""};Scanner.prototype.scan=function(a){var b=this.tail.match(a);if(b&&b.index===0){var c=b[0];this.tail=this.tail.substring(c.length);this.pos+=c.length;return c}return""};Scanner.prototype.scanUntil=function(a){var b=this.tail.search(a),match;switch(b){case-1:match=this.tail;this.tail="";break;case 0:match="";break;default:match=this.tail.substring(0,b);this.tail=this.tail.substring(b)}this.pos+=match.length;return match};function Context(a,b){this.view=a==null?{}:a;this.parent=b;this._cache={'.':this.view}}Context.make=function(a){return(a instanceof Context)?a:new Context(a)};Context.prototype.push=function(a){return new Context(a,this)};Context.prototype.lookup=function(a){var b;if(a in this._cache){b=this._cache[a]}else{var c=this;while(c){if(a.indexOf('.')>0){b=c.view;var d=a.split('.'),i=0;while(b!=null&&i<d.length){b=b[d[i++]]}}else{b=c.view[a]}if(b!=null)break;c=c.parent}this._cache[a]=b}if(isFunction(b)){b=b.call(this.view)}return b};function Writer(){this.clearCache()}Writer.prototype.clearCache=function(){this._cache={};this._partialCache={}};Writer.prototype.compile=function(a,b){var c=this._cache[a];if(!c){var d=l.parse(a,b);c=this._cache[a]=this.compileTokens(d,a)}return c};Writer.prototype.compilePartial=function(a,b,c){var d=this.compile(b,c);this._partialCache[a]=d;return d};Writer.prototype.getPartial=function(a){if(!(a in this._partialCache)&&this._loadPartial){this.compilePartial(a,this._loadPartial(a))}return this._partialCache[a]};Writer.prototype.compileTokens=function(d,e){var f=this;return function(a,b){if(b){if(isFunction(b)){f._loadPartial=b}else{for(var c in b){f.compilePartial(c,b[c])}}}return renderTokens(d,f,Context.make(a),e)}};Writer.prototype.render=function(a,b,c){return this.compile(a)(b,c)};function renderTokens(b,c,d,e){var f='';function subRender(a){return c.render(a,d)}var g,tokenValue,value;for(var i=0,len=b.length;i<len;++i){g=b[i];tokenValue=g[1];switch(g[0]){case'#':value=d.lookup(tokenValue);if(typeof value==='object'||typeof value==='string'){if(v(value)){for(var j=0,jlen=value.length;j<jlen;++j){f+=renderTokens(g[4],c,d.push(value[j]),e)}}else if(value){f+=renderTokens(g[4],c,d.push(value),e)}}else if(isFunction(value)){var h=e==null?null:e.slice(g[3],g[5]);value=value.call(d.view,h,subRender);if(value!=null)f+=value}else if(value){f+=renderTokens(g[4],c,d,e)}break;case'^':value=d.lookup(tokenValue);if(!value||(v(value)&&value.length===0)){f+=renderTokens(g[4],c,d,e)}break;case'>':value=c.getPartial(tokenValue);if(isFunction(value))f+=value(d);break;case'&':value=d.lookup(tokenValue);if(value!=null)f+=value;break;case'name':value=d.lookup(tokenValue);if(value!=null)f+=l.escape(value);break;case'text':f+=tokenValue;break}}return f}function nestTokens(a){var b=[];var c=b;var d=[];var e;for(var i=0,len=a.length;i<len;++i){e=a[i];switch(e[0]){case'#':case'^':d.push(e);c.push(e);c=e[4]=[];break;case'/':var f=d.pop();f[5]=e[2];c=d.length>0?d[d.length-1][4]:b;break;default:c.push(e)}}return b}function squashTokens(a){var b=[];var c,lastToken;for(var i=0,len=a.length;i<len;++i){c=a[i];if(c){if(c[0]==='text'&&lastToken&&lastToken[0]==='text'){lastToken[1]+=c[1];lastToken[3]=c[3]}else{lastToken=c;b.push(c)}}}return b}function escapeTags(a){return[new RegExp(escapeRegExp(a[0])+"\\s*"),new RegExp("\\s*"+escapeRegExp(a[1]))]}function parseTemplate(a,b){a=a||'';b=b||l.tags;if(typeof b==='string')b=b.split(n);if(b.length!==2)throw new Error('Invalid tags: '+b.join(', '));var c=escapeTags(b);var d=new Scanner(a);var e=[];var f=[];var g=[];var h=false;var j=false;function stripSpace(){if(h&&!j){while(g.length){delete f[g.pop()]}}else{g=[]}h=false;j=false}var k,type,value,chr,token,openSection;while(!d.eos()){k=d.pos;value=d.scanUntil(c[0]);if(value){for(var i=0,len=value.length;i<len;++i){chr=value.charAt(i);if(isWhitespace(chr)){g.push(f.length)}else{j=true}f.push(['text',chr,k,k+1]);k+=1;if(chr=='\n')stripSpace()}}if(!d.scan(c[0]))break;h=true;type=d.scan(r)||'name';d.scan(m);if(type==='='){value=d.scanUntil(p);d.scan(p);d.scanUntil(c[1])}else if(type==='{'){value=d.scanUntil(new RegExp('\\s*'+escapeRegExp('}'+b[1])));d.scan(q);d.scanUntil(c[1]);type='&'}else{value=d.scanUntil(c[1])}if(!d.scan(c[1]))throw new Error('Unclosed tag at '+d.pos);token=[type,value,k,d.pos];f.push(token);if(type==='#'||type==='^'){e.push(token)}else if(type==='/'){openSection=e.pop();if(!openSection){throw new Error('Unopened section "'+value+'" at '+k);}if(openSection[1]!==value){throw new Error('Unclosed section "'+openSection[1]+'" at '+k);}}else if(type==='name'||type==='{'||type==='&'){j=true}else if(type==='='){b=value.split(n);if(b.length!==2){throw new Error('Invalid tags at '+k+': '+b.join(', '));}c=escapeTags(b)}}openSection=e.pop();if(openSection){throw new Error('Unclosed section "'+openSection[1]+'" at '+d.pos);}return nestTokens(squashTokens(f))}l.name="mustache.js";l.version="0.7.3";l.tags=["{{","}}"];l.Scanner=Scanner;l.Context=Context;l.Writer=Writer;l.parse=parseTemplate;l.escape=escapeHtml;var x=new Writer();l.clearCache=function(){return x.clearCache()};l.compile=function(a,b){return x.compile(a,b)};l.compilePartial=function(a,b,c){return x.compilePartial(a,b,c)};l.compileTokens=function(a,b){return x.compileTokens(a,b)};l.render=function(a,b,c){return x.render(a,b,c)};l.to_html=function(a,b,c,d){var e=l.render(a,b,c);if(isFunction(d)){d(e)}else{return e}}}));